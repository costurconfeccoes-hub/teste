<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de QR Codes - Confecção</title>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js'
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            query, 
            where, 
            updateDoc,
            doc 
        } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js'
        
        const firebaseConfig = {
            apiKey: "AIzaSyAc1iUDZEjyDOtrY9UT_idP5_TGODIsc9E",
            authDomain: "costur-agendamentos.firebaseapp.com",
            projectId: "costur-agendamentos",
            storageBucket: "costur-agendamentos.firebasestorage.app",
            messagingSenderId: "948222283708",
            appId: "1:948222283708:web:a82876883f247e51ede5b9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Exportar funções para uso global
        window.firebase = {
            db,
            collection,
            getDocs,
            query,
            where,
            updateDoc,
            doc
        };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            padding: 15px;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            text-align: center;
            margin-bottom: 15px;
        }
        
        .header h1 {
            color: #0f172a;
            margin-bottom: 5px;
            font-size: 22px;
        }
        
        .header p {
            color: #64748b;
            font-size: 13px;
        }
        
        .content {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .form-container {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 6px;
            border: 2px solid #cbd5e1;
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #334155;
            font-size: 13px;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid #cbd5e0;
            border-radius: 5px;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
        }
        
        .form-group select {
            cursor: pointer;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #475569;
        }
        
        /* Campo quantidade apenas leitura */
        .form-group .readonly-input {
            background-color: #f8fafc;
            border-color: #cbd5e1;
            color: #475569;
            cursor: not-allowed;
            user-select: none;
        }
        
        .form-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .form-column {
            flex: 1;
            min-width: 180px;
        }
        
        .generate-btn {
            background: #475569;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            transition: all 0.2s;
            margin-top: 5px;
        }
        
        .generate-btn:hover {
            background: #334155;
        }
        
        .generate-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        
        .preview-area {
            margin-top: 15px;
            display: none;
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .preview-header h2 {
            color: #0f172a;
            font-size: 16px;
        }
        
        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            font-size: 13px;
        }
        
        .print-btn {
            background: #475569;
            color: white;
        }
        
        .print-btn:hover {
            background: #334155;
        }
        
        .new-batch-btn {
            background: #64748b;
            color: white;
        }
        
        .new-batch-btn:hover {
            background: #475569;
        }
        
        /* GRID COM BORDAS CINZA CLARO PARA SEPARAÇÃO */
        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, 65px);
            gap: 0;
            padding: 0;
            background: white;
            border-radius: 0;
            border: none;
            justify-content: center;
        }
        
        .qr-item {
            width: 65px;
            height: 65px;
            padding: 0;
            margin: 0;
            border: 0.5px solid #e5e7eb;
            background: white;
            position: relative;
            box-sizing: border-box;
        }
        
        .qr-code {
            width: 64px;
            height: 64px;
            padding: 0;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
        }
        
        .data-preview {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
            word-break: break-all;
            display: none;
        }
        
        .footer {
            text-align: center;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #e2e8f0;
            color: #64748b;
            font-size: 11px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 15px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #475569;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            animation: spin 1s linear infinite;
            margin: 0 auto 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ESTILOS DE IMPRESSÃO COM BORDAS VISÍVEIS */
        @media print {
            .header, .form-container, .controls, .footer,
            .new-batch-btn, .generate-btn, .data-preview {
                display: none !important;
            }
            
            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            .container {
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .content {
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            .preview-area {
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* 1.7cm + 0.5mm de borda = 17.5mm total */
            .qr-grid {
                display: grid !important;
                grid-template-columns: repeat(10, 17.5mm) !important;
                gap: 0 !important;
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
                page-break-inside: avoid !important;
            }
            
            .qr-item {
                width: 17.5mm !important;
                height: 17.5mm !important;
                min-width: 17.5mm !important;
                min-height: 17.5mm !important;
                padding: 0 !important;
                margin: 0 !important;
                border: 0.3mm solid #e5e7eb !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                box-sizing: border-box !important;
            }
            
            .qr-code {
                width: 17mm !important;
                height: 17mm !important;
                min-width: 17mm !important;
                min-height: 17mm !important;
                padding: 0 !important;
                margin: 0 !important;
                background: white !important;
            }
            
            .qr-code canvas, .qr-code img {
                width: 16.5mm !important;
                height: 16.5mm !important;
                min-width: 16.5mm !important;
                min-height: 16.5mm !important;
                display: block !important;
                background: white !important;
            }
            
            /* MARGENS PERSONALIZADAS */
            @page {
                size: A4;
                margin-left: 10mm;   /* 1cm esquerda */
                margin-right: 10mm;  /* 1cm direita */
                margin-top: 3mm;     /* superior padrão */
                margin-bottom: 20mm; /* 2cm inferior */
            }
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .form-column {
                min-width: 100%;
            }
            
            .preview-header {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }
            
            .controls {
                width: 100%;
                justify-content: center;
            }
            
            .qr-grid {
                grid-template-columns: repeat(auto-fill, 65px);
            }
        }
        
        /* Estilos adicionais para informações do corte */
        .corte-info {
            font-size: 12px;
            color: #475569;
            margin-top: 5px;
            padding: 5px;
            background: #f1f5f9;
            border-radius: 3px;
            border-left: 3px solid #475569;
        }
        
        .success-msg {
            background: #d1fae5;
            color: #065f46;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #10b981;
        }
        
        .info-tooltip {
            position: relative;
            cursor: help;
        }
        
        .info-tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 0;
            background: #334155;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
        }
        
        /* Estilo para campo de quantidade de QR codes */
        .qr-quantity-group {
            margin-top: 10px;
        }
        
        .qr-quantity-group label {
            font-weight: 600;
            color: #334155;
            font-size: 13px;
            display: block;
            margin-bottom: 5px;
        }
        
        .qr-quantity-input {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid #cbd5e0;
            border-radius: 5px;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
        }
        
        .qr-quantity-input:focus {
            outline: none;
            border-color: #475569;
        }
    </style>
    <!-- Biblioteca para gerar QR Codes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-qrcode"></i> GERADOR DE QR CODES</h1>
            <p>Sistema de Rastreabilidade - Confecção</p>
        </div>
        
        <div class="content">
            <div class="form-container">
                <div class="form-row">
                    <div class="form-column">
                        <div class="form-group">
                            <label for="selectCorte">
                                <i class="fas fa-cut"></i> SELECIONE O CORTE EM PRODUÇÃO
                            </label>
                            <select id="selectCorte" required>
                                <option value="">Carregando cortes em produção...</option>
                            </select>
                            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                                <i class="fas fa-info-circle"></i> Mostrando apenas documentos com status "in-production"
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-column">
                        <div class="form-group">
                            <label for="quantidadeCorte">
                                <i class="fas fa-boxes"></i> QUANTIDADE DO CORTE
                            </label>
                            <input type="number" id="quantidadeCorte" 
                                   class="readonly-input"
                                   readonly
                                   disabled
                                   style="background-color: #f1f5f9; color: #475569; font-weight: bold;">
                            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                                <i class="fas fa-lock"></i> Quantidade fixa do corte (não editável)
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="qr-quantity-group">
                    <label for="quantidadeQR">
                        <i class="fas fa-qrcode"></i> QUANTIDADE DE QR CODES A GERAR (1-1500)
                    </label>
                    <input type="number" id="quantidadeQR" 
                           class="qr-quantity-input"
                           min="1" max="1500" 
                           value="100"
                           required>
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">
                        <i class="fas fa-exclamation-circle"></i> Esta é a quantidade de QR Codes que serão gerados para impressão
                    </div>
                </div>
                
                <button class="generate-btn" id="generateBtn" disabled>
                    <i class="fas fa-bolt"></i> GERAR QR CODES
                </button>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Carregando dados do Firebase...</p>
            </div>
            
            <div class="preview-area" id="previewArea">
                <div class="data-preview" id="dataPreview">
                    <!-- Dados de exemplo serão mostrados aqui -->
                </div>
                
                <div class="preview-header">
                    <h2>QR Codes para Impressão</h2>
                    <div class="controls">
                        <button class="control-btn print-btn" id="printBtn">
                            <i class="fas fa-print"></i> IMPRIMIR
                        </button>
                        <button class="control-btn new-batch-btn" id="newBatchBtn">
                            <i class="fas fa-redo"></i> NOVO
                        </button>
                    </div>
                </div>
                
                <div class="qr-grid" id="qrGrid">
                    <!-- QR Codes serão gerados aqui -->
                </div>
                
                <div class="footer">
                    <p><i class="fas fa-industry"></i> Sistema de produção têxtil com rastreabilidade individual</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Elementos da página
        const generateBtn = document.getElementById('generateBtn');
        const printBtn = document.getElementById('printBtn');
        const newBatchBtn = document.getElementById('newBatchBtn');
        const previewArea = document.getElementById('previewArea');
        const loading = document.getElementById('loading');
        const qrGrid = document.getElementById('qrGrid');
        const dataPreview = document.getElementById('dataPreview');
        const selectCorte = document.getElementById('selectCorte');
        const quantidadeCorte = document.getElementById('quantidadeCorte'); // Campo imutável
        const quantidadeQR = document.getElementById('quantidadeQR'); // Campo para quantidade de QR codes
        
        // Variáveis
        let cortesEmProducao = [];
        let documentoSelecionadoId = ''; // Para armazenar o ID do documento Firestore
        
        // Formato do texto para o QR Code
        function formatarTextoQR(idCorte, sequencia) {
            const agora = new Date();
            const dataGeracao = agora.toISOString().split('T')[0];
            const horaGeracao = agora.toTimeString().split(' ')[0];
            
            return `IDCORTE: ${idCorte}
SEQUENCIA: ${sequencia}
DATA: ${dataGeracao}
GERADO: ${dataGeracao} ${horaGeracao}`;
        }
        
        // Carregar cortes em produção do Firebase (da coleção appointments)
        async function carregarCortesEmProducao() {
            try {
                loading.style.display = 'block';
                selectCorte.innerHTML = '<option value="">Carregando cortes em produção...</option>';
                generateBtn.disabled = true;
                
                const db = window.firebase.db;
                const queryRef = window.firebase.query;
                const collectionRef = window.firebase.collection;
                const getDocs = window.firebase.getDocs;
                const where = window.firebase.where;
                
                // Buscar documentos com status "in-production" na coleção appointments
                const q = queryRef(
                    collectionRef(db, "appointments"),
                    where("status", "==", "in-production")
                );
                
                const querySnapshot = await getDocs(q);
                
                cortesEmProducao = [];
                selectCorte.innerHTML = '<option value="">Selecione um corte em produção</option>';
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    cortesEmProducao.push({
                        id: doc.id, // ID do documento Firestore
                        documentNumber: data.documentNumber || "SEM-NÚMERO",
                        clientName: data.clientName || "Cliente não informado",
                        serviceType: data.serviceType || "Serviço não especificado",
                        quantity: data.quantity || 0, // Quantidade do corte
                        serviceDate: data.serviceDate || "Sem data",
                        estimatedDays: data.estimatedDays || 0
                    });
                    
                    // Adicionar ao select
                    const option = document.createElement('option');
                    option.value = data.documentNumber || doc.id;
                    option.dataset.docId = doc.id; // Armazenar ID do documento
                    option.dataset.quantity = data.quantity || 0; // Armazenar quantidade
                    option.textContent = `${data.documentNumber || "DOC-" + doc.id.substring(0,8)} - ${data.clientName || "Sem cliente"} (${data.serviceType || "serviço"})`;
                    selectCorte.appendChild(option);
                });
                
                if (cortesEmProducao.length === 0) {
                    selectCorte.innerHTML = '<option value="">Nenhum corte em produção encontrado</option>';
                    const optionInfo = document.createElement('option');
                    optionInfo.value = '';
                    optionInfo.textContent = '⚠️ Verifique se há documentos com status "in-production"';
                    selectCorte.appendChild(optionInfo);
                } else {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="fas fa-bolt"></i> GERAR QR CODES';
                }
                
                loading.style.display = 'none';
                console.log('Cortes carregados:', cortesEmProducao);
                
            } catch (error) {
                console.error("Erro ao carregar cortes:", error);
                selectCorte.innerHTML = '<option value="">Erro ao carregar dados do Firebase</option>';
                const optionError = document.createElement('option');
                optionError.value = '';
                optionError.textContent = '❌ Erro: ' + error.message.substring(0, 50);
                selectCorte.appendChild(optionError);
                loading.style.display = 'none';
            }
        }
        
        // Atualizar quantidade no Firestore
        async function atualizarQuantidadeNoFirestore(docId, quantidade) {
            try {
                const db = window.firebase.db;
                const updateDoc = window.firebase.updateDoc;
                const docRef = window.firebase.doc;
                
                const documentoRef = docRef(db, "appointments", docId);
                
                await updateDoc(documentoRef, {
                    quantity: quantidade,
                    updatedAt: new Date().toISOString(),
                    qrGenerated: true,
                    qrGeneratedAt: new Date().toISOString()
                });
                
                console.log(`Quantidade ${quantidade} salva no documento ${docId}`);
                return true;
                
            } catch (error) {
                console.error("Erro ao atualizar quantidade:", error);
                return false;
            }
        }
        
        // Gerar QR Codes
        generateBtn.addEventListener('click', async function() {
            const documentNumber = selectCorte.value;
            const quantidade = parseInt(quantidadeQR.value); // Usar a quantidade de QR codes
            const selectedOption = selectCorte.options[selectCorte.selectedIndex];
            const docId = selectedOption.dataset.docId;
            
            // Validações
            if (!documentNumber || !docId) {
                alert("Selecione um corte válido em produção!");
                selectCorte.focus();
                return;
            }
            
            if (quantidade < 1 || quantidade > 1500) {
                alert("Quantidade de QR Codes deve ser entre 1 e 1500!");
                quantidadeQR.focus();
                return;
            }
            
            // Armazenar ID do documento selecionado
            documentoSelecionadoId = docId;
            
            // Mostrar loading
            loading.style.display = 'block';
            previewArea.style.display = 'none';
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> GERANDO...';
            
            // Limpar grid anterior
            qrGrid.innerHTML = '';
            
            try {
                // 1. Primeiro, atualizar a quantidade do CORTE no Firestore (se necessário)
                const quantidadeDoCorte = parseInt(quantidadeCorte.value) || 0;
                const atualizado = await atualizarQuantidadeNoFirestore(docId, quantidadeDoCorte);
                
                if (!atualizado) {
                    alert("Atenção: Não foi possível atualizar o banco de dados, mas os QR Codes serão gerados.");
                } else {
                    // Atualizar visualmente no select
                    const corteIndex = cortesEmProducao.findIndex(c => c.id === docId);
                    if (corteIndex !== -1) {
                        cortesEmProducao[corteIndex].quantity = quantidadeDoCorte;
                        selectedOption.dataset.quantity = quantidadeDoCorte;
                    }
                }
                
                // 2. Mostrar exemplo dos dados
                const exemploTexto = formatarTextoQR(documentNumber, 1);
                dataPreview.textContent = `DADOS DO CORTE:\n• Documento: ${documentNumber}\n• Quantidade do corte: ${quantidadeDoCorte}\n• QR Codes a gerar: ${quantidade}\n• Atualizado em: ${new Date().toLocaleString()}\n\nEXEMPLO DE QR CODE:\n${exemploTexto}`;
                dataPreview.style.display = 'block';
                
                // 3. Gerar os QR Codes
                await generateQRCodes(documentNumber, quantidade);
                
                // Esconder loading e mostrar preview
                loading.style.display = 'none';
                previewArea.style.display = 'block';
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-bolt"></i> GERAR QR CODES';
                
                // Mostrar mensagem de sucesso
                const successMsg = document.createElement('div');
                successMsg.className = 'success-msg';
                successMsg.innerHTML = `<i class="fas fa-check-circle"></i> <strong>Sucesso!</strong> ${quantidade} QR Codes gerados para o corte ${documentNumber}.`;
                dataPreview.parentNode.insertBefore(successMsg, dataPreview.nextSibling);
                
                // Foco no botão de impressão
                printBtn.focus();
                
            } catch (error) {
                alert("Erro ao gerar QR Codes: " + error.message);
                loading.style.display = 'none';
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-bolt"></i> GERAR QR CODES';
            }
        });
        
        // Função para gerar QR Codes
        async function generateQRCodes(idCorte, quantidade) {
            const batchSize = 100;
            let generated = 0;
            
            // Tamanho ajustado para 64px (1.7cm) com borda de 1px
            const qrSize = 64;
            
            for (let i = 1; i <= quantidade; i += batchSize) {
                const end = Math.min(i + batchSize - 1, quantidade);
                
                for (let j = i; j <= end; j++) {
                    // Criar texto para o QR Code
                    const textoQR = formatarTextoQR(idCorte, j);
                    
                    // Criar container do QR Code COM BORDA
                    const qrItem = document.createElement('div');
                    qrItem.className = 'qr-item';
                    qrItem.id = `qr-${idCorte}-${j}`;
                    qrItem.title = `ID: ${idCorte}-${j}`;
                    qrItem.style.border = '0.5px solid #e5e7eb';
                    
                    // Div para o QR Code
                    const qrDiv = document.createElement('div');
                    qrDiv.className = 'qr-code';
                    qrDiv.style.width = `${qrSize}px`;
                    qrDiv.style.height = `${qrSize}px`;
                    
                    // Adicionar ao item
                    qrItem.appendChild(qrDiv);
                    
                    // Adicionar ao grid
                    qrGrid.appendChild(qrItem);
                    
                    // Gerar QR Code
                    new QRCode(qrDiv, {
                        text: textoQR,
                        width: qrSize - 2,
                        height: qrSize - 2,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.Q
                    });
                    
                    generated++;
                }
                
                // Pequena pausa para não travar a interface
                await new Promise(resolve => setTimeout(resolve, 30));
            }
        }
        
        // Imprimir com bordas visíveis e margens personalizadas
        printBtn.addEventListener('click', function() {
            // Preparar para impressão
            const printWindow = window.open('', '_blank');
            
            // Configuração para 1.7cm + borda
            const qrSizeMM = 17;
            const borderMM = 0.5;
            const totalSizeMM = qrSizeMM + borderMM;
            
            // MARGENS PERSONALIZADAS (1cm esquerda/direita, 2cm inferior)
            const marginLeftMM = 10;   // 1cm
            const marginRightMM = 10;  // 1cm
            const marginTopMM = 3;     // 3mm superior
            const marginBottomMM = 20; // 2cm inferior
            
            const paperWidthMM = 210;
            const paperHeightMM = 297;
            
            // Largura disponível após margens
            const availableWidthMM = paperWidthMM - marginLeftMM - marginRightMM;
            
            // Calcular quantos cabem por linha considerando bordas
            const qrPerRow = Math.floor(availableWidthMM / totalSizeMM);
            const availableHeightMM = paperHeightMM - marginTopMM - marginBottomMM;
            const qrPerCol = Math.floor(availableHeightMM / totalSizeMM);
            const qrPerPage = qrPerRow * qrPerCol;
            
            // Obter dados do lote
            const idCorte = selectCorte.value;
            const quantidade = parseInt(quantidadeQR.value);
            const dataAtual = new Date().toLocaleDateString('pt-BR');
            
            // Criar conteúdo otimizado para impressão COM BORDAS
            const qrItems = document.querySelectorAll('.qr-item');
            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>QR Codes - ${idCorte}</title>
                    <meta charset="UTF-8">
                    <style>
                        /* MARGENS PERSONALIZADAS */
                        @page {
                            size: A4;
                            margin-left: ${marginLeftMM}mm;
                            margin-right: ${marginRightMM}mm;
                            margin-top: ${marginTopMM}mm;
                            margin-bottom: ${marginBottomMM}mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: Arial, sans-serif;
                            background: white;
                        }
                        .page-header {
                            text-align: center;
                            margin-bottom: 3mm;
                            font-size: 9pt;
                            color: #333;
                            padding: 2mm;
                            border-bottom: 0.5px solid #ddd;
                        }
                        .page {
                            width: 100%;
                            height: 100%;
                            page-break-after: always;
                        }
                        .qr-grid {
                            display: grid;
                            grid-template-columns: repeat(${qrPerRow}, ${totalSizeMM}mm);
                            grid-auto-rows: ${totalSizeMM}mm;
                            gap: 0;
                            width: 100%;
                            background: white;
                        }
                        .qr-item {
                            width: ${totalSizeMM}mm;
                            height: ${totalSizeMM}mm;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border: ${borderMM}mm solid #e5e7eb;
                            box-sizing: border-box;
                            background: white;
                            page-break-inside: avoid;
                            break-inside: avoid;
                        }
                        .qr-code {
                            width: ${qrSizeMM}mm;
                            height: ${qrSizeMM}mm;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            overflow: hidden;
                            background: white;
                        }
                        .qr-code img {
                            width: ${qrSizeMM - 0.5}mm;
                            height: ${qrSizeMM - 0.5}mm;
                            max-width: ${qrSizeMM - 0.5}mm;
                            max-height: ${qrSizeMM - 0.5}mm;
                            image-rendering: crisp-edges;
                            background: white;
                        }
                        .page-footer {
                            position: absolute;
                            bottom: ${marginBottomMM - 15}mm;
                            left: ${marginLeftMM}mm;
                            width: calc(100% - ${marginLeftMM + marginRightMM}mm);
                            text-align: center;
                            font-size: 7pt;
                            color: #666;
                        }
                    </style>
                </head>
                <body>
            `;
            
            let currentPage = 1;
            let qrCount = 0;
            const totalPages = Math.ceil(quantidade / qrPerPage);
            
            // Organizar por páginas
            while (qrCount < qrItems.length) {
                html += `<div class="page">`;
                html += `<div class="page-header">
                    <strong>${idCorte}</strong> | ${quantidade} QR Codes | Página ${currentPage}/${totalPages} | ${dataAtual}
                </div>`;
                
                html += `<div class="qr-grid">`;
                
                for (let i = 0; i < qrPerPage && qrCount < qrItems.length; i++) {
                    const qrItem = qrItems[qrCount];
                    const qrImg = qrItem.querySelector('img') || qrItem.querySelector('canvas');
                    
                    if (qrImg) {
                        const imgSrc = qrImg.tagName === 'CANVAS' ? qrImg.toDataURL('image/png') : qrImg.src;
                        html += `
                            <div class="qr-item">
                                <div class="qr-code">
                                    <img src="${imgSrc}" alt="QR Code ${idCorte}-${qrCount + 1}">
                                </div>
                            </div>
                        `;
                    }
                    qrCount++;
                }
                
                html += `</div>`;
                html += `<div class="page-footer">
                    Gerado em: ${new Date().toLocaleString('pt-BR')}
                </div>`;
                html += `</div>`;
                currentPage++;
            }
            
            html += `</body></html>`;
            
            // Abrir janela de impressão
            printWindow.document.write(html);
            printWindow.document.close();
            
            // Esperar carregar e imprimir
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                    printWindow.onafterprint = function() {
                        printWindow.close();
                    };
                }, 250);
            };
        });
        
        // Novo lote
        newBatchBtn.addEventListener('click', function() {
            previewArea.style.display = 'none';
            qrGrid.innerHTML = '';
            dataPreview.style.display = 'none';
            
            // Remover mensagens de sucesso
            const successMsgs = document.querySelectorAll('.success-msg');
            successMsgs.forEach(msg => msg.remove());
            
            selectCorte.selectedIndex = 0;
            quantidadeCorte.value = '';
            quantidadeQR.value = '100';
            documentoSelecionadoId = '';
            selectCorte.focus();
        });
        
        // Atalhos de teclado
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                generateBtn.click();
            }
            if (e.ctrlKey && e.key === 'p' && previewArea.style.display !== 'none') {
                e.preventDefault();
                printBtn.click();
            }
        });
        
        // Quando selecionar um corte, mostrar informações
        selectCorte.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const docId = selectedOption.dataset.docId;
            const quantidadeDoCorte = selectedOption.dataset.quantity || 0;
            
            if (docId) {
                // Atualizar campo de quantidade do corte (imutável)
                quantidadeCorte.value = quantidadeDoCorte;
                
                // Definir valor inicial para quantidade de QR codes (mas o usuário pode alterar)
                quantidadeQR.value = Math.min(quantidadeDoCorte || 100, 1500);
                
                const corte = cortesEmProducao.find(c => c.id === docId);
                if (corte) {
                    // Adicionar tooltip ou info
                    const infoDiv = document.getElementById('corteInfo');
                    if (!infoDiv) {
                        const newInfoDiv = document.createElement('div');
                        newInfoDiv.id = 'corteInfo';
                        newInfoDiv.className = 'corte-info';
                        newInfoDiv.innerHTML = `
                            <i class="fas fa-info-circle"></i> 
                            Cliente: ${corte.clientName} | 
                            Serviço: ${corte.serviceType} | 
                            Data: ${corte.serviceDate || "Não informada"}
                        `;
                        this.parentNode.appendChild(newInfoDiv);
                    } else {
                        infoDiv.innerHTML = `
                            <i class="fas fa-info-circle"></i> 
                            Cliente: ${corte.clientName} | 
                            Serviço: ${corte.serviceType} | 
                            Data: ${corte.serviceDate || "Não informada"}
                        `;
                    }
                }
            } else {
                // Limpar campos se nenhum corte selecionado
                quantidadeCorte.value = '';
                quantidadeQR.value = '100';
                
                // Remover info se existir
                const infoDiv = document.getElementById('corteInfo');
                if (infoDiv) {
                    infoDiv.remove();
                }
            }
        });
        
        // Focar no select ao carregar
        window.onload = async function() {
            // Carregar cortes em produção do Firebase
            await carregarCortesEmProducao();
            
            if (selectCorte.options.length > 1) {
                selectCorte.focus();
            }
        };
    </script>
</body>
</html>
